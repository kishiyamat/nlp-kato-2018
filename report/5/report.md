# 課題1

　まず与えられた文書1--6に含まれる単語の単語頻度`tf`を
データフレーム`df`に与える[^R]。
そして各文書ごとの類似度を`tf`値を用いて求める。

[^R]: 回答の一部にはGNU Rを用いた。

```r
df <- data.frame(
#    word =c( 'ウィルス', 'エイズ ', '肝炎', '感染', 'コンピュータ',
#             '被害','ファイル','米国','メール'),
    tf.d1=c(4,0,0,3,1,1,0,1,2),
    tf.d2=c(3,0,0,3,1,1,1,0,2),
    tf.d3=c(2,0,0,1,2,1,2,0,0),
    tf.d4=c(2,1,1,2,0,1,0,3,0),
    tf.d5=c(1,0,2,2,0,1,0,0,0),
    tf.d6=c(1,3,0,3,0,1,0,0,0))
```

類似度を求めるために
各文書から2つ選択する組み合わせを
`docs.C.2`リストとして作成する。
そして
`docs.C.2`の`V1`と`V2`が示す文書のベクトルを
先ほどの文書ベクトルから取得し、
前回の課題で作成したコサイン類似度を求める関数に適用して
類似度を求め、`sim`という列に格納する。

２つのクラスターの類似度をどうやって代表させるか、
が問題。
一番手っ取り早いのはリスト動詞のコンビネーションを作る
見たい２つのcが分かれば類似度は求められる。

```r
library(dplyr)
library(purrr)

# 組み合わせの行列を作る
combn(colnames(df), 2)
docs.C.2 <- as.data.frame(t(combn(colnames(df), 2)))
docs.C.2$sim = 1:nrow(docs.C.2) %>% map_dbl(function(i) 
             Sim.c(unlist(select(df,as.character(docs.C.2[i,]$V1))) ,
                   unlist(select(df,as.character(docs.C.2[i,]$V2)))))
docs.C.2
##       V1    V2       sim
## 1  tf.d1 tf.d2 0.9545942
## 2  tf.d1 tf.d3 0.6614378
## 3  tf.d1 tf.d4 0.7115125
## 4  tf.d1 tf.d5 0.6149187
## 5  tf.d1 tf.d6 0.5533986
## 6  tf.d2 tf.d3 0.7483315
## 7  tf.d2 tf.d4 0.5813777
## 8  tf.d2 tf.d5 0.6324555
## 9  tf.d2 tf.d6 0.5813777
## 10 tf.d3 tf.d4 0.4183300
## 11 tf.d3 tf.d5 0.4225771
## 12 tf.d3 tf.d6 0.3585686
## 13 tf.d4 tf.d5 0.6363961
## 14 tf.d4 tf.d6 0.6000000
## 15 tf.d5 tf.d6 0.5656854

docs.C.2[docs.C.2$sim==(docs.C.2$sim %>% max),]
```

上のデータフレームを表にすると以下のとおりとなる。
最も似ているのは文書1と文書2である(コサイン類似度=0.95)。
これらを統合したさいにクラスターが発生するが、
そのクラスターと他の文書の類似度は複数の方法で求められる。
本課題では完全リンク法と単一リンク法を用いてクラスタリングする。
そしてそれぞれで作成したクラスターに対し
樹形図を作成する。

|       | tf.d2 | tf.d3 | tf.d4 | tf.d5 | tf.d6 |
| ----- | ----- | ----- | ----- | ----- | ----- |
| tf.d1 | 0.954 | 0.661 | 0.711 | 0.614 | 0.553 |
| tf.d2 |       | 0.748 | 0.581 | 0.632 | 0.581 |
| tf.d3 |       |       | 0.418 | 0.422 | 0.358 |
| tf.d4 |       |       |       | 0.636 | 0.600 |
| tf.d5 |       |       |       |       | 0.565 |

## 完全リンク法

まず完全リンク法でクラスタリングする。
始めに文書1と文書2を結合しクラスターを作成し、
そのクラスターと他文書の類似度を測る。
完全リンク砲は類似度の最小値をとるため、
以下のような表を作成できる。
文書1,2が形成するクラスターと
他の文書との類似度は最小となるものを選択する。
文書3と最も離れているのは文書1(0.661)なので、
これが文書1,2のクラスターと文書3のクラスターの類似度となる。
文書4では文書2の0.581,文書5では文書1との0.614,
文書6では文書1の0.553が新しい類似度となる。


|         | tf.d3 | tf.d4 | tf.d5 | tf.d6 |
| -----   | ----- | ----- | ----- | ----- |
| tf.d1+2 | 0.661 | 0.581 | 0.614 | 0.553 |
| tf.d3   |       | 0.418 | 0.422 | 0.358 |
| tf.d4   |       |       | 0.636 | 0.600 |
| tf.d5   |       |       |       | 0.565 |

次は1,2のクラスターと3をくっつける。
すると文書1,2,3と他のクラスターの類似度を見て、
もっとも離れている値を新しい類似度とする。

|           | tf.d4 | tf.d5 | tf.d6 |
| -----     | ----- | ----- | ----- |
| tf.d1+2+3 | 0.418 | 0.422 | 0.358 |
| tf.d4     |       | 0.636 | 0.600 |
| tf.d5     |       |       | 0.565 |

次にクラスターを形成するのは文書4と文書5である。
文書4,5と文書1,2,3の組み合わせをそれぞれ見て、
最も離れている値を選択する。
すると0.418が文書4,5--文書1,2,3間の類似度となることが分かる。
また文書4,5と文書6は0.60か0.56の選択肢があるが、
後者が選択される。

|           | tf.d4+5 | tf.d6 |
| -----     | ------- | ----- |
| tf.d1+2+3 | 0.418   | 0.358 |
| tf.d4+5   |         | 0.565 |

次は文書4,5と文書6をくっつけ、これらの類似度は0.358となる。

|           | tf.d4+5+6|
| -----     | -------  |
| tf.d1+2+3 | 0.358    |


## 単一リンク法

|       | tf.d2 | tf.d3 | tf.d4 | tf.d5 | tf.d6 |
| ----- | ----- | ----- | ----- | ----- | ----- |
| tf.d1 | 0.954 | 0.661 | 0.711 | 0.614 | 0.553 |
| tf.d2 |       | 0.748 | 0.581 | 0.632 | 0.581 |
| tf.d3 |       |       | 0.418 | 0.422 | 0.358 |
| tf.d4 |       |       |       | 0.636 | 0.600 |
| tf.d5 |       |       |       |       | 0.565 |

もっとも似ている値を類似度とする。
文書1と文書2が形成するクラスターと
他の文書の類似度を比較し、
もっとも高い値をクラスターと文書間の類似度とする。

|         | tf.d3 | tf.d4 | tf.d5 | tf.d6 |
| -----   | ----- | ----- | ----- | ----- |
| tf.d1+2 | 0.748 | 0.711 | 0.632 | 0.581 |
| tf.d3   |       | 0.418 | 0.422 | 0.358 |
| tf.d4   |       |       | 0.636 | 0.600 |
| tf.d5   |       |       |       | 0.565 |

次は文書1,2と文書3である。

|           | tf.d4 | tf.d5 | tf.d6 |
| -----     | ----- | ----- | ----- |
| tf.d1+2+3 | 0.711 | 0.632 | 0.581 |
| tf.d4     |       | 0.636 | 0.600 |
| tf.d5     |       |       | 0.565 |

次は文書123と文書4
先ほどの例では文書4と統合されるのは
文書5であったが、
単一リンク法が作る新しいクラスターの類似度の方法により、
たかい値が維持されてくっつき続けるようにみえる。

|             | tf.d5 | tf.d6 |
| ----        | ----- | ----- |
| tf.d1+2+3+4 | 0.636 | 0.600 |
| tf.d5       |       | 0.565 |

最後はこうなる。

|               | tf.d6 |
| ----          | ----- |
| tf.d1+2+3+4+5 | 0.600 |

## 前回つくったコサイン類似度を求める関数

```r
# lとrの内積を返す中置関数を定義
'%ip%' <- function (l,r) {
    # 入力のベクトルl,rを列に格納
    tmp <- data.frame(l=l,r=r)
    # l.rという列名の各列にl*rを格納
    tmp$l.r <- tmp$l * tmp$r 
    # l.rの和を取る
    sum(tmp$l.r)}


# ベクトル(Ws)の長さを返す関数を定義
D <- function(Ws) sqrt(sum(Ws ** 2))

# Sim.c :: numeric -> numeric -> double
# 第一引数にq(uestion), 第二引数にd(ocument vector)
Sim.c <- function(q,d) q %ip% d / (D(d) * D(q))
```

　以上の関数の動作を確認する。
講義内で扱われた検索質問<2,1,3,0>を`q0`、
対象となった文書のベクトル<4,3,0,5>を`q0`とする。
それらを関数に入れることで余弦尺度が求まる。
なお、単語の情報は各列のindexからアクセスできる。

```r
# 文書1 = <2,1,3,0> と 質問=<4,3,0,5> で動作確認
d0 <- c(0,0,3,3) 
q0 <- c(4,3,0,5)

Sim.c(q0)(d0)
## [1] 0.4157609
```

　最初の検索質問は<薬:1.0, 風邪:3.0, 熱:2.0>であった。
まずはこの質問を`q1`に格納し、
`Sim.c.q1` にこの質問との類似度を返す関数を格納する。

```r
# 検索質問: 薬、風邪、熱
q1 = c(1,3,2,0,0,0)

# q1との類似度を返す関数
Sim.c.q1 <- Sim.c(q1)

# 1薬、2風邪、3熱、4のど、5胃、6消化のベクトル
df $ tf.idf.1 
## [1] 2.088624 6.521776 0.000000 3.568636 0.000000 0.000000
```

データフレーム`df`の`tf.idf.1`には
文書1のベクトルが入っているので、
これを`Sim.c.q1`に与えれば`q1`と文書1の類似度が求まる。
それを`df.sim`という表に格納する

```r
df.sim <- data.frame(
    d1 = Sim.c.q1(df $ tf.idf.1) ,
    d2 = Sim.c.q1(df $ tf.idf.2) ,
    d3 = Sim.c.q1(df $ tf.idf.3) ,
    d4 = Sim.c.q1(df $ tf.idf.4) ,
    d5 = Sim.c.q1(df $ tf.idf.5) )

df.sim
#          d1       d2        d3        d4         d5
# 1 0.7494399 0.955446 0.4074928 0.1164894 0.02758927

df.sim[order(df.sim[1,],decreasing=T)]
#         d2        d1        d3        d4         d5
# 1 0.955446 0.7494399 0.4074928 0.1164894 0.02758927
```

　表に格納した後は降順にして出力する。
その結果、文書2, 文書1, 文書3, そして文書4,5の順で
似ていたことが分かる。

　次の検索質問は<薬:1.0, 胃:2.0>であったので、
同様の手順を繰り返す。

```r
# 検索質問: 薬(index:1)、胃(index:5)
q2 = c(1,0,0,0,2,0)
# q1との類似度を返す関数
Sim.c.q2 <- Sim.c(q2)
```

　そして各文書ベクトルを
`Sim.c.q2`に与えれば`q2`との類似度が求まる。
それを`df.sim`という表に格納する

```r
df.sim <- data.frame(
    d1 = Sim.c.q2(df $ tf.idf.1) ,
    d2 = Sim.c.q2(df $ tf.idf.2) ,
    d3 = Sim.c.q2(df $ tf.idf.3) ,
    d4 = Sim.c.q2(df $ tf.idf.4) ,
    d5 = Sim.c.q2(df $ tf.idf.5) )

df.sim
#          d1        d2        d3        d4        d5
# 1 0.1209592 0.1280726 0.1884064 0.8580712 0.2555781

df.sim[order(df.sim[1,],decreasing=T)]
#          d4        d5        d3        d2        d1
# 1 0.8580712 0.2555781 0.1884064 0.1280726 0.1209592
```

　ソートの結果、文書4, 文書5, 文書3, 文書2,文書1の順で
類似度が検索質問2に近いことが分かった。
