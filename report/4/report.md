# 課題1

はじめに与えられた文書1--5に含まれる各語1--6の
単語頻度`tf(t,d)`を求める。
そして各単語に対して与えられた文書頻度`df(t)`と
単語頻度`tf(t,d)`を
語を基準に表形式で変数`df`に格納する。
なお、文書の集合が含む文書数は`N`に格納する。

```r
df <- data.frame(
    word =c( '薬', '風邪', '熱', '喉', '胃', '消化'),
    df   =c(9030 ,   670 , 184 ,  27 , 428 ,   359 ),
    tf.d1=c(   2 ,     3 ,   0 ,   1 ,   0 ,     0 ),
    tf.d2=c(   1 ,     1 ,   1 ,   0 ,   0 ,     0 ),
    tf.d3=c(   2 ,     0 ,   1 ,   1 ,   0 ,     0 ),
    tf.d4=c(   4 ,     0 ,   0 ,   0 ,   3 ,     2 ),
    tf.d5=c(   1 ,     0 ,   0 ,   0 ,   1 ,     4 ))

N <- 10000
## > df
##   word   df tf.d1 tf.d2 tf.d3 tf.d4 tf.d5
## 1   薬 9030     2     1     2     4     1
## 2 風邪  670     3     1     0     0     0
## 3   熱  184     0     1     1     0     0
## 4   喉   27     1     0     1     0     0
## 5   胃  428     0     0     0     3     1
## 6 消化  359     0     0     0     2     4
```

次に`tf(t,d)`,`d(t)`,`N`を引数に
`tf*idf`を求める関数`tf.idf`を定義する。
そして`tf.idf`を文書ごとに適用し、
各文書における、そして各単語に対する`tf*idf`
を求める。

```r
tf.idf <- function(tf.d, df, N) tf.d*(log10(N/df)+1)

df$tf.idf.1 <- tf.idf(df$tf.d1, df$df, N)
df$tf.idf.2 <- tf.idf(df$tf.d2, df$df, N)
df$tf.idf.3 <- tf.idf(df$tf.d3, df$df, N)
df$tf.idf.4 <- tf.idf(df$tf.d4, df$df, N)
df$tf.idf.5 <- tf.idf(df$tf.d5, df$df, N)

##   word   df tf.d1 tf.d2 tf.d3 tf.d4 tf.d5 df.1 
## 1   薬 9030     2     1     2     4     1    5 
## 2 風邪  670     3     1     0     0     0    2 
## 3   熱  184     0     1     1     0     0    2 
## 4   喉   27     1     0     1     0     0    2 
## 5   胃  428     0     0     0     3     1    2 
## 6 消化  359     0     0     0     2     4    2 
##   tf.idf.1 tf.idf.2 tf.idf.3 tf.idf.4 tf.idf.5
## 1 2.088624 1.044312 2.088624 4.177249 1.044312
## 2 6.521776 2.173925 0.000000 0.000000 0.000000
## 3 0.000000 2.735182 2.735182 0.000000 0.000000
## 4 3.568636 0.000000 3.568636 0.000000 0.000000
## 5 0.000000 0.000000 0.000000 7.105669 2.368556
## 6 0.000000 0.000000 0.000000 4.889811 9.779622
```

上の計算にしたがい、各単語に対する`tf*idf`値は
以下のとおりとなる。列名は文書名を示し、
`tf.idf.1`は文書位置に対する各単語の`tf*idf`値
となっている。つまり、
`tf.idf.1`と`薬`が交差する点は、
文書1の「薬」という単語に対する
`tf*idf`値である。

```r
##      tf.idf.1 tf.idf.2 tf.idf.3 tf.idf.4 tf.idf.5
##   薬 2.088624 1.044312 2.088624 4.177249 1.044312
## 風邪 6.521776 2.173925 0.000000 0.000000 0.000000
##   熱 0.000000 2.735182 2.735182 0.000000 0.000000
##   喉 3.568636 0.000000 3.568636 0.000000 0.000000
##   胃 0.000000 0.000000 0.000000 7.105669 2.368556
## 消化 0.000000 0.000000 0.000000 4.889811 9.779622
```

# 課題2

次に上で求めた文書ごとの単語に対する`tf*idf`を
各文書を表象する重みとみなし文書特徴表現とする。
したがって、以下の列をそのまま
各文書の特徴とする。

```r
##      tf.idf.1 tf.idf.2 tf.idf.3 tf.idf.4 tf.idf.5
##   薬 2.088624 1.044312 2.088624 4.177249 1.044312
## 風邪 6.521776 2.173925 0.000000 0.000000 0.000000
##   熱 0.000000 2.735182 2.735182 0.000000 0.000000
##   喉 3.568636 0.000000 3.568636 0.000000 0.000000
##   胃 0.000000 0.000000 0.000000 7.105669 2.368556
## 消化 0.000000 0.000000 0.000000 4.889811 9.779622
```

これに対し、検索質問<薬:1.0, 風邪:3.0, 熱:2.0>と
<薬:1.0, 胃:2.0>との類似度を求めて並び替える。
ベクトル同士の類似度には余弦尺度が使えるので
必要な関数を定義する。
まず`%ip%`は引数のベクトル同士を2列に格納し、
行ごとの積を取り、その結果の和をとる中置関数である。
また、`D`はベクトルの長さを返す関数である。
余弦尺度を求める関数`Sim.c`
はまず固定したいベクトルを取り
そのベクトルに対する類似度を返す関数とする。

```r
# lとrの内積を返す中置関数を定義
'%ip%' <- function (l,r) {
    # 入力のベクトルl,rを列に格納
    tmp <- data.frame(l=l,r=r)
    # l.rという列名の各列にl*rを格納
    tmp$l.r <- tmp$l * tmp$r 
    # l.rの和を取る
    sum(tmp$l.r)}


# ベクトル(Ws)の長さを返す関数を定義
D <- function(Ws) sqrt(sum(Ws ** 2))

Sim.c <- function(q) function(d) q %ip% d / (D(d) * D(q))
```

以上の関数で動作の確認を行う。
講義内で扱われた検索質問を`q0`、
対象となった文書を`q0`とする。
それらを関数に入れることで余弦尺度が求まる。
なお、単語の情報は各列のindexからアクセスできる。

```r
# 文書1 = <2,1,3,0> と 質問=<4,3,0,5> で動作確認
d0 <- c(2,1,3,0) 
q0 <- c(4,3,0,5)

Sim.c(q0)(d0)
>[1] 0.4157609
```

最初の検索質問は<薬:1.0, 風邪:3.0, 熱:2.0>であった。
まずはこの質問を`q1`に束縛する。


```r
# 1薬、2風邪、3熱、4のど、5胃、6消化のベクトル
df.tf.idf $ tf.idf.1 
# 1薬、2風邪、3熱のベクトル
df.rep <- data.frame(
    d1 = df $ tf.idf.1 [c(1,2,3)],
    d2 = df $ tf.idf.2 [c(1,2,3)],
    d3 = df $ tf.idf.3 [c(1,2,3)],
    d4 = df $ tf.idf.4 [c(1,2,3)],
    d5 = df $ tf.idf.5 [c(1,2,3)])

# 検索質問: 薬、風邪、熱
q1 = c(1,3,2)
Sim.c.q1 <- Sim.c(q1)

Sim.c.q1(df.rep$d1)

df.sim <- data.frame(
    d1 = Sim.c.q1(df.rep $ d1) ,
    d2 = Sim.c.q1(df.rep $ d2) ,
    d3 = Sim.c.q1(df.rep $ d3) ,
    d4 = Sim.c.q1(df.rep $ d4) ,
    d5 = Sim.c.q1(df.rep $ d5) )

t(df.sim)

order(df.sim[1,])

data.frame(
    cos.d1.q1 = q1 %ip% d1 / (D(d1) * D(q1)),
    cos.d2.q1 = q1 %ip% d2 / (D(d2) * D(q1)),
    cos.d3.q1 = q1 %ip% d3 / (D(d3) * D(q1)),
    cos.d4.q1 = q1 %ip% d4 / (D(d4) * D(q1)),
    cos.d5.q1 = q1 %ip% d5 / (D(d5) * D(q1)))
```

次の検索質問は<薬:1.0, 胃:2.0>であった。

```r
# 1薬、5胃のベクトル
df.tf.idf $ tf.idf.1 [c(1,5)]
# 検索質問: 薬、胃
d1 = df.tf.idf $ tf.idf.1 [c(1,5)]
d2 = df.tf.idf $ tf.idf.2 [c(1,5)]
d3 = df.tf.idf $ tf.idf.3 [c(1,5)]
d4 = df.tf.idf $ tf.idf.4 [c(1,5)]
d5 = df.tf.idf $ tf.idf.5 [c(1,5)]

q2 = c(1,2)
data.frame(
    cos.d1.q2 = q2 %ip% d1 / (D(d1) * D(q2)),
    cos.d2.q2 = q2 %ip% d2 / (D(d2) * D(q2)),
    cos.d3.q2 = q2 %ip% d3 / (D(d3) * D(q2)),
    cos.d4.q2 = q2 %ip% d4 / (D(d4) * D(q2)),
    cos.d5.q2 = q2 %ip% d5 / (D(d5) * D(q2)))
```
